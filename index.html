<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>registro de capacitaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-900 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // =============== ICONS ===============
        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
            </svg>
        );

        const CheckIcon = ({ completed }) => (
            <svg xmlns="http://www.w3.org/2000/svg" 
                className={`h-6 w-6 transition-all duration-300 ease-in-out transform ${completed ? 'scale-100 text-green-400' : 'scale-0 text-slate-500'}`} 
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        
        const CopyIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" />
            </svg>
        );

        // =============== SIGNATURE PAD ===============
        const SignaturePad = ({ onSave }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            const getPosition = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const event = e.touches ? e.touches[0] : e;
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top,
                };
            };

            const startDrawing = (e) => {
                const { x, y } = getPosition(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const { x, y } = getPosition(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = () => {
                const ctx = canvasRef.current.getContext('2d');
                ctx.closePath();
                setIsDrawing(false);
            };
            
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseleave', stopDrawing);
                canvas.addEventListener('touchstart', startDrawing);
                canvas.addEventListener('touchmove', draw);
                canvas.addEventListener('touchend', stopDrawing);

                return () => {
                    canvas.removeEventListener('mousedown', startDrawing);
                    canvas.removeEventListener('mousemove', draw);
                    canvas.removeEventListener('mouseup', stopDrawing);
                    canvas.removeEventListener('mouseleave', stopDrawing);
                    canvas.removeEventListener('touchstart', startDrawing);
                    canvas.removeEventListener('touchmove', draw);
                    canvas.removeEventListener('touchend', stopDrawing);
                };
            }, [isDrawing]);


            const clear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            const save = () => {
                const dataUrl = canvasRef.current.toDataURL();
                onSave(dataUrl);
                clear();
            };

            return (
                <div className="flex flex-col items-center space-y-2 w-full">
                    <canvas ref={canvasRef} width="300" height="150" className="bg-slate-700 rounded-md shadow-inner" />
                    <div className="flex space-x-2">
                        <button onClick={clear} type="button" className="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-md text-sm font-medium">Limpiar</button>
                        <button onClick={save} type="button" className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-md text-sm font-medium">Guardar Firma</button>
                    </div>
                </div>
            );
        };

        // =============== MAIN APP ===============
        const App = () => {
            const [appState, setAppState] = useState(() => {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    try {
                        const decodedState = JSON.parse(atob(hash));
                        return {
                            ...decodedState,
                            view: 'checklist',
                            files: decodedState.files.map(file => ({...file, visited: false })),
                            records: [],
                        };
                    } catch (e) {
                        console.error("Error parsing state from URL", e);
                    }
                }
                
                const savedState = localStorage.getItem('attendanceApp');
                return savedState ? JSON.parse(savedState) : {
                    view: 'setup',
                    trainingName: '',
                    files: [{ url: '' }],
                    records: [],
                };
            });
            
            useEffect(() => {
                localStorage.setItem('attendanceApp', JSON.stringify(appState));
            }, [appState]);

            const handleFileChange = (index, value) => {
                const newFiles = [...appState.files];
                newFiles[index].url = value;
                setAppState(prev => ({ ...prev, files: newFiles }));
            };

            const addFile = () => {
                setAppState(prev => ({ ...prev, files: [...prev.files, { url: '' }] }));
            };

            const removeFile = (index) => {
                const newFiles = appState.files.filter((_, i) => i !== index);
                setAppState(prev => ({ ...prev, files: newFiles }));
            };

            const handleConfirmFiles = () => {
                const config = {
                    trainingName: appState.trainingName,
                    files: appState.files.filter(f => f.url.trim() !== ''),
                };
                const base64Config = btoa(JSON.stringify(config));
                window.location.hash = base64Config;
                setAppState(prev => ({ ...prev, view: 'share' }));
            };

            const handleMarkVisited = (index) => {
                const newFiles = [...appState.files];
                newFiles[index].visited = true;
                const allVisited = newFiles.every(file => file.visited);
                setAppState(prev => ({ ...prev, files: newFiles, view: allVisited ? 'form' : prev.view }));
            };
            
            const handleCopyLink = () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Enlace copiado al portapapeles!');
                });
            };

            const handleReset = () => {
                localStorage.removeItem('attendanceApp');
                window.location.hash = '';
                 setAppState({
                    view: 'setup',
                    trainingName: '',
                    files: [{ url: '' }],
                    records: [],
                });
            };

            const renderSetup = () => (
                <div className="w-full max-w-lg mx-auto p-6 bg-slate-800 rounded-lg shadow-xl">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-white">Configuración de Capacitación</h2>
                        <button onClick={handleReset} className="text-sm text-slate-400 hover:text-white">Reiniciar</button>
                    </div>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Nombre de la Capacitación</label>
                            <input
                                type="text"
                                value={appState.trainingName}
                                onChange={(e) => setAppState(prev => ({...prev, trainingName: e.target.value}))}
                                className="w-full bg-slate-700 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="Ej: Inducción de Seguridad"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Enlaces a Materiales</label>
                            {appState.files.map((file, index) => (
                                <div key={index} className="flex items-center space-x-2 mb-2">
                                    <input
                                        type="url"
                                        value={file.url}
                                        onChange={(e) => handleFileChange(index, e.target.value)}
                                        className="flex-grow bg-slate-700 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="https://docs.google.com/..."
                                    />
                                    <button onClick={() => removeFile(index)} className="p-2 text-slate-400 hover:text-red-500">
                                        <TrashIcon />
                                    </button>
                                </div>
                            ))}
                        </div>
                        <button onClick={addFile} className="text-indigo-400 hover:text-indigo-300 text-sm font-medium">+ Agregar otro enlace</button>
                    </div>
                    <div className="mt-6">
                        <button 
                          onClick={handleConfirmFiles} 
                          disabled={!appState.trainingName || appState.files.every(f => !f.url)}
                          className="w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-500 rounded-md font-semibold text-white disabled:bg-slate-600 disabled:cursor-not-allowed">
                            Confirmar Archivos
                        </button>
                    </div>
                </div>
            );
            
            const renderShareLink = () => (
                <div className="w-full max-w-lg mx-auto p-6 bg-slate-800 rounded-lg shadow-xl text-center">
                    <h2 className="text-2xl font-bold text-white mb-4">¡Listo para Compartir!</h2>
                    <p className="text-slate-300 mb-4">Copia y envía este enlace a los asistentes para que puedan registrarse.</p>
                    <div className="p-2 bg-slate-900 rounded-md mb-4 text-left overflow-x-auto">
                        <code className="text-indigo-300 text-sm">{window.location.href}</code>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-2">
                        <button onClick={handleCopyLink} className="flex-1 py-2 px-4 bg-indigo-600 hover:bg-indigo-500 rounded-md font-semibold text-white flex items-center justify-center gap-2">
                            <CopyIcon /> Copiar Enlace
                        </button>
                        <button onClick={() => setAppState(prev => ({...prev, view: 'checklist'}))} className="flex-1 py-2 px-4 bg-slate-600 hover:bg-slate-500 rounded-md font-semibold text-white">
                            Continuar a la Lista
                        </button>
                    </div>
                </div>
            );

            const renderChecklist = () => (
                <div className="w-full max-w-lg mx-auto p-6 bg-slate-800 rounded-lg shadow-xl">
                    <h2 className="text-2xl font-bold text-white mb-2">{appState.trainingName}</h2>
                    <p className="text-slate-300 mb-6">Por favor, abre y revisa cada uno de los siguientes materiales para continuar.</p>
                    <ul className="space-y-3">
                        {appState.files.map((file, index) => (
                            <li key={index} className={`flex items-center p-3 rounded-md transition-colors duration-300 ${file.visited ? 'bg-green-900/50' : 'bg-slate-700'}`}>
                                <CheckIcon completed={file.visited} />
                                <a 
                                    href={file.url} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    onClick={() => handleMarkVisited(index)}
                                    className="ml-3 text-indigo-400 hover:text-indigo-300 truncate flex-1"
                                >
                                    {`Material de Capacitación #${index + 1}`}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            );
            
            const renderForm = () => {
                const [formData, setFormData] = useState({
                    participantName: '',
                    participantPosition: '',
                    participantEmpresa: '',
                    trainingDate: new Date().toISOString().slice(0, 10),
                    signature: ''
                });

                const handleChange = (e) => {
                    setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                };

                const handleSaveSignature = (signatureData) => {
                    setFormData(prev => ({...prev, signature: signatureData}));
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!formData.signature) {
                        alert("Por favor, guarda tu firma antes de registrarte.");
                        return;
                    }
                    const newRecord = { ...formData, courseName: appState.trainingName };
                    setAppState(prev => ({ ...prev, records: [...prev.records, newRecord]}));
                    setFormData({
                        participantName: '',
                        participantPosition: '',
                        participantEmpresa: '',
                        trainingDate: new Date().toISOString().slice(0, 10),
                        signature: ''
                    });
                };
                
                const handleExportPDF = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.text(`Registro de Asistencia: ${appState.trainingName}`, 14, 16);
                    doc.setFontSize(10);
                    doc.text(`Exportado el: ${new Date().toLocaleDateString()}`, 14, 22);

                    const tableColumn = ["Nombre", "Cargo", "Empresa", "Fecha", "Firma"];
                    const tableRows = [];

                    appState.records.forEach(record => {
                        const recordData = [
                            record.participantName,
                            record.participantPosition,
                            record.participantEmpresa,
                            record.trainingDate,
                            '' // Placeholder for signature image
                        ];
                        tableRows.push(recordData);
                    });

                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 30,
                        didDrawCell: (data) => {
                            if (data.section === 'body' && data.column.index === 4) {
                                const record = appState.records[data.row.index];
                                if (record.signature) {
                                    doc.addImage(record.signature, 'PNG', data.cell.x + 2, data.cell.y + 2, 30, 15);
                                }
                            }
                        },
                        styles: {
                            cellPadding: 2,
                        },
                        columnStyles: {
                            4: { // Signature column
                                minCellWidth: 35,
                            }
                        }
                    });

                    doc.save(`asistencia_${appState.trainingName.replace(/\s+/g, '_')}.pdf`);
                };

                return (
                    <div className="w-full max-w-4xl mx-auto p-6 space-y-8">
                       <div className="bg-slate-800 p-6 rounded-lg shadow-xl">
                            <h2 className="text-2xl font-bold mb-6">Registrar Asistente para: {appState.trainingName}</h2>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <input type="text" name="participantName" value={formData.participantName} onChange={handleChange} placeholder="Nombre del Asistente" required className="bg-slate-700 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <input type="text" name="participantPosition" value={formData.participantPosition} onChange={handleChange} placeholder="Cargo" required className="bg-slate-700 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <input type="text" name="participantEmpresa" value={formData.participantEmpresa} onChange={handleChange} placeholder="Empresa" required className="bg-slate-700 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <input type="date" name="trainingDate" value={formData.trainingDate} onChange={handleChange} required className="bg-slate-700 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <div className="md:col-span-2 flex flex-col items-center">
                                    <label className="text-sm font-medium text-slate-300 mb-2">Firma</label>
                                    <SignaturePad onSave={handleSaveSignature} />
                                </div>
                                <button type="submit" disabled={!formData.signature} className="md:col-span-2 w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-500 rounded-md font-semibold text-white disabled:bg-slate-600 disabled:cursor-not-allowed">
                                    Registrar Asistencia
                                </button>
                            </form>
                        </div>

                        {appState.records.length > 0 && (
                             <div className="bg-slate-800 p-6 rounded-lg shadow-xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Asistentes Registrados</h3>
                                    <button onClick={handleExportPDF} className="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-md text-sm font-medium">Exportar a PDF</button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-300">
                                        <thead className="text-xs text-slate-400 uppercase bg-slate-700">
                                            <tr>
                                                <th scope="col" className="px-6 py-3">Nombre</th>
                                                <th scope="col" className="px-6 py-3">Cargo</th>
                                                <th scope="col" className="px-6 py-3">Empresa</th>
                                                <th scope="col" className="px-6 py-3">Fecha</th>
                                                <th scope="col" className="px-6 py-3">Firma</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {appState.records.map((record, i) => (
                                                <tr key={i} className="bg-slate-800 border-b border-slate-700">
                                                    <td className="px-6 py-4">{record.participantName}</td>
                                                    <td className="px-6 py-4">{record.participantPosition}</td>
                                                    <td className="px-6 py-4">{record.participantEmpresa}</td>
                                                    <td className="px-6 py-4">{record.trainingDate}</td>
                                                    <td className="px-6 py-4">
                                                        <img src={record.signature} alt="Firma" className="h-8 bg-white p-1 rounded"/>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="container mx-auto px-4 py-8">
                    <header className="text-center mb-8">
                        <h1 className="text-4xl font-extrabold tracking-tight text-white">Registro de Capacitaciones</h1>
                    </header>
                    <main>
                        {appState.view === 'setup' && renderSetup()}
                        {appState.view === 'share' && renderShareLink()}
                        {appState.view === 'checklist' && renderChecklist()}
                        {appState.view === 'form' && renderForm()}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
