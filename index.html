<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Asistencia a Capacitaciones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, forwardRef, useImperativeHandle } = React;

    // --- ICON COMPONENTS ---
    const SaveIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
      </svg>
    );
    const ClearIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );
    const ExportIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
      </svg>
    );
    const CheckIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-5 w-5"} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
        </svg>
    );
    const TrashIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
    );
    
    // --- SIGNATURE PAD COMPONENT ---
    const SignaturePad = forwardRef(({ width = 400, height = 200 }, ref) => {
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [isEmpty, setIsEmpty] = useState(true);

      const getCanvasContext = () => {
        const canvas = canvasRef.current;
        if (!canvas) return null;
        return canvas.getContext('2d');
      };

      const clearCanvas = () => {
        const context = getCanvasContext();
        if (context && canvasRef.current) {
          context.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
          setIsEmpty(true);
        }
      };

      const getSignatureDataURL = () => {
        if (isEmpty || !canvasRef.current) return null;
        return canvasRef.current.toDataURL('image/png');
      };

      useImperativeHandle(ref, () => ({
        clear: clearCanvas,
        getSignature: getSignatureDataURL,
        get isEmpty() { return isEmpty; }
      }));

      const getCoords = (event) => {
        if (!canvasRef.current) return null;
        const rect = canvasRef.current.getBoundingClientRect();
        if (event.touches && event.touches.length > 0) {
          return { x: event.touches[0].clientX - rect.left, y: event.touches[0].clientY - rect.top };
        }
        return { x: event.clientX - rect.left, y: event.clientY - rect.top };
      };

      const startDrawing = (event) => {
        event.preventDefault();
        const coords = getCoords(event);
        if (!coords) return;
        const context = getCanvasContext();
        if (!context) return;
        
        context.beginPath();
        context.moveTo(coords.x, coords.y);
        setIsDrawing(true);
        setIsEmpty(false);
      };
      
      const draw = (event) => {
        if (!isDrawing) return;
        event.preventDefault();
        const coords = getCoords(event);
        if (!coords) return;
        const context = getCanvasContext();
        if (!context) return;

        context.lineTo(coords.x, coords.y);
        context.stroke();
      };
      
      const stopDrawing = (event) => {
        event.preventDefault();
        const context = getCanvasContext();
        if (!context) return;

        context.closePath();
        setIsDrawing(false);
      };

      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const context = canvas.getContext('2d');
        if (!context) return;

        const resizeCanvas = () => {
            const { width, height } = canvas.getBoundingClientRect();
            if(canvas.width !== width || canvas.height !== height) {
                canvas.width = width;
                canvas.height = height;
                context.strokeStyle = '#FFFFFF';
                context.lineWidth = 2;
                context.lineCap = 'round';
                context.lineJoin = 'round';
            }
        };
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });

        return () => {
            window.removeEventListener('resize', resizeCanvas);
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseleave', stopDrawing);
            canvas.removeEventListener('touchstart', startDrawing);
            canvas.removeEventListener('touchmove', draw);
            canvas.removeEventListener('touchend', stopDrawing);
        };
      }, [isDrawing]);

      return (
        <div className="relative w-full h-48 bg-gray-700 rounded-lg border-2 border-dashed border-gray-500 cursor-crosshair overflow-hidden">
          <canvas ref={canvasRef} className="w-full h-full" />
          {isEmpty && (
            <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center text-gray-400 pointer-events-none">
              Firme aquí
            </div>
          )}
        </div>
      );
    });

    // --- ATTENDANCE FORM COMPONENT ---
    const InputField = ({ id, label, type = 'text', value, onChange }) => (
      <div>
        <label htmlFor={id} className="block text-sm font-medium text-gray-300 mb-1">{label}</label>
        <input
          type={type}
          id={id}
          name={id}
          value={value}
          onChange={onChange}
          className="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
          required
        />
      </div>
    );

    const AttendanceForm = ({ onSave, disabled }) => {
      const getInitialState = () => ({
        trainingDate: new Date().toISOString().split('T')[0],
        participantName: '',
        participantPosition: '',
        participantEmpresa: '',
      });

      const [formData, setFormData] = useState(getInitialState());
      const [error, setError] = useState('');
      const signaturePadRef = useRef(null);

      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
      };

      const handleClear = () => {
        setFormData(getInitialState());
        signaturePadRef.current?.clear();
        setError('');
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        const signature = signaturePadRef.current?.getSignature();

        if (signaturePadRef.current?.isEmpty || !signature) {
          setError('La firma del participante es obligatoria.');
          return;
        }
        
        setError('');
        onSave({ ...formData, signature });
        handleClear();
      };

      return (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg relative">
          {disabled && (
            <div className="absolute inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-10 rounded-xl cursor-not-allowed">
              <p className="text-lg text-gray-300 font-medium text-center p-4">
                Primero ingrese el nombre de la capacitación.
              </p>
            </div>
          )}
          <h2 className="text-2xl font-bold text-white mb-6">Nuevo Registro de Asistente</h2>
          <form onSubmit={handleSubmit} className="space-y-4">
            <fieldset disabled={disabled}>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="md:col-span-2">
                  <InputField id="participantName" label="Nombre del Participante" value={formData.participantName} onChange={handleChange} />
                </div>
                <InputField id="participantPosition" label="Cargo" value={formData.participantPosition} onChange={handleChange} />
                <InputField id="participantEmpresa" label="Empresa" value={formData.participantEmpresa} onChange={handleChange} />
                 <div className="md:col-span-2">
                    <InputField id="trainingDate" label="Fecha de Capacitación" type="date" value={formData.trainingDate} onChange={handleChange} />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Firma del Participante</label>
                <SignaturePad ref={signaturePadRef} />
              </div>

              {error && <p className="text-red-400 text-sm">{error}</p>}

              <div className="flex items-center justify-end space-x-4 pt-4">
                <button type="button" onClick={handleClear} className="flex items-center justify-center px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-500 transition duration-200">
                  <ClearIcon /> Limpiar
                </button>
                <button type="submit" className="flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-500 transition duration-200">
                  <SaveIcon /> Guardar
                </button>
              </div>
            </fieldset>
          </form>
        </div>
      );
    };

    // --- RECORDS TABLE COMPONENT ---
    const RecordsTable = ({ records, onExport }) => {
      return (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg mt-8 lg:mt-0">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-white">Registros Guardados</h2>
            <button
              onClick={onExport}
              disabled={records.length === 0}
              className="flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-500 transition duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
            >
              <ExportIcon /> Exportar a PDF
            </button>
          </div>

          <div className="overflow-x-auto">
            {records.length === 0 ? (
              <p className="text-gray-400 text-center py-8">No hay registros aún.</p>
            ) : (
              <table className="min-w-full divide-y divide-gray-700">
                <thead className="bg-gray-700/50">
                  <tr>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Curso</th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Participante</th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Fecha</th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Firma</th>
                  </tr>
                </thead>
                <tbody className="bg-gray-800 divide-y divide-gray-700">
                  {records.map((record) => (
                    <tr key={record.id} className="hover:bg-gray-700/50 transition-colors">
                      <td className="px-6 py-4 whitespace-nowrap"><div className="text-sm font-medium text-white">{record.courseName}</div></td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm text-white">{record.participantName}</div>
                        <div className="text-xs text-gray-400">{record.participantPosition} - {record.participantEmpresa}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{record.trainingDate}</td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <img src={record.signature} alt="Signature" className="w-28 h-14 object-contain bg-white rounded-md p-1" />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    };

    // --- MAIN APP COMPONENT ---
    const App = () => {
      const [appState, setAppState] = useState('setup'); // 'setup', 'checklist', 'form'
      const [files, setFiles] = useState([{ url: '', code: '' }]);
      const [checklist, setChecklist] = useState([]);

      const [records, setRecords] = useState([]);
      const [courseName, setCourseName] = useState('');

      useEffect(() => {
        if (appState === 'checklist' && checklist.length > 0 && checklist.every(file => file.verified)) {
          setTimeout(() => setAppState('form'), 1000);
        }
      }, [checklist, appState]);

      const handleFileChange = (index, field, value) => {
        const newFiles = [...files];
        newFiles[index][field] = value;
        setFiles(newFiles);
      };

      const handleAddFile = () => {
        setFiles([...files, { url: '', code: '' }]);
      };

      const handleRemoveFile = (index) => {
        setFiles(files.filter((_, i) => i !== index));
      };

      const handleConfirmFiles = () => {
        const validFiles = files.filter(f => f.url.trim().startsWith('http') && f.code.trim() !== '');
        if (validFiles.length === 0) {
          alert('Por favor, ingrese al menos un enlace válido y su palabra clave.');
          return;
        }
        setChecklist(validFiles.map((file, index) => ({
          ...file,
          name: `Archivo de capacitación #${index + 1}`,
          verified: false,
          userInput: '',
          error: false
        })));
        setAppState('checklist');
      };

      const handleChecklistInputChange = (index, value) => {
        const newChecklist = [...checklist];
        newChecklist[index].userInput = value;
        newChecklist[index].error = false;
        setChecklist(newChecklist);
      };

      const handleVerifyCode = (index) => {
        const newChecklist = [...checklist];
        if (newChecklist[index].userInput.trim().toLowerCase() === newChecklist[index].code.trim().toLowerCase()) {
            newChecklist[index].verified = true;
            newChecklist[index].error = false;
        } else {
            newChecklist[index].error = true;
        }
        setChecklist(newChecklist);
      };

      const handleSaveRecord = useCallback((newRecordData) => {
        if (!courseName) return;
        const newRecord = {
          ...newRecordData,
          courseName,
          id: new Date().toISOString() + Math.random(),
        };
        setRecords(prevRecords => [newRecord, ...prevRecords]);
      }, [courseName]);

      const handleExportPDF = useCallback(() => {
        if (records.length === 0) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.text(`Registro de Asistencia: ${courseName}`, 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Fecha de exportación: ${new Date().toLocaleDateString()}`, 14, 30);

        doc.autoTable({
          startY: 38,
          head: [['#', 'Participante', 'Cargo', 'Empresa', 'Fecha', 'Firma']],
          body: records.map((r, i) => [i + 1, r.participantName, r.participantPosition, r.participantEmpresa, r.trainingDate, '']),
          theme: 'grid',
          didDrawCell: (data) => {
            if (data.section === 'body' && data.column.index === 5) {
              const record = records[data.row.index];
              if (record?.signature) {
                const imgWidth = 35, imgHeight = 15;
                const x = data.cell.x + (data.cell.width - imgWidth) / 2;
                const y = data.cell.y + (data.cell.height - imgHeight) / 2;
                doc.addImage(record.signature, 'PNG', x, y, imgWidth, imgHeight);
              }
            }
          },
        });
        doc.save(`registro_asistencia_${courseName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
      }, [records, courseName]);

      const renderSetup = () => (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg animate-fade-in max-w-2xl mx-auto">
          <h2 className="text-xl font-bold text-white mb-2">Paso 1: Configurar Archivos</h2>
          <p className="text-gray-400 mb-4">Ingrese los enlaces del material y una palabra clave para cada uno. La palabra clave debe aparecer al final del contenido para que el asistente la use como verificación.</p>
          <div className="space-y-4">
            {files.map((file, index) => (
              <div key={index} className="flex flex-col sm:flex-row items-center gap-2 p-3 bg-gray-700/50 rounded-lg">
                <input type="url" className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500" value={file.url} onChange={(e) => handleFileChange(index, 'url', e.target.value)} placeholder="Enlace del archivo..."/>
                <input type="text" className="w-full sm:w-48 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500" value={file.code} onChange={(e) => handleFileChange(index, 'code', e.target.value)} placeholder="Palabra clave"/>
                <button onClick={() => handleRemoveFile(index)} className="p-2 bg-red-600 text-white rounded-md hover:bg-red-500 disabled:opacity-50" disabled={files.length <= 1}><TrashIcon /></button>
              </div>
            ))}
          </div>
          <div className="flex items-center justify-between mt-4">
            <button onClick={handleAddFile} className="px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-500">+ Agregar otro</button>
            <button onClick={handleConfirmFiles} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-500">Confirmar y Continuar</button>
          </div>
        </div>
      );

      const renderChecklist = () => (
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg animate-fade-in max-w-2xl mx-auto">
          <h2 className="text-xl font-bold text-white mb-2">Paso 2: Revisar Material</h2>
          <p className="text-gray-400 mb-6">Abra cada enlace, revise el contenido hasta el final y escriba la palabra clave para verificar.</p>
          <ul className="space-y-3">
            {checklist.map((file, index) => (
              <li key={index} className={`p-3 rounded-md transition-all duration-300 ${file.verified ? 'bg-green-800/50' : 'bg-gray-700'}`}>
                <a href={file.url} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline font-medium">{file.name}</a>
                {!file.verified && (
                    <div className="flex items-center gap-2 mt-2">
                      <input type="text" placeholder="Ingrese la palabra clave" value={file.userInput} onChange={(e) => handleChecklistInputChange(index, e.target.value)} className={`flex-grow bg-gray-600 border rounded-md py-1 px-2 text-white ${file.error ? 'border-red-500' : 'border-gray-500'}`} />
                      <button onClick={() => handleVerifyCode(index)} className="px-3 py-1 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-500 text-sm">Verificar</button>
                    </div>
                )}
                {file.verified && <div className="flex items-center text-green-400 mt-2"><CheckIcon className="h-5 w-5 mr-2" /> Verificado</div>}
              </li>
            ))}
          </ul>
        </div>
      );

      const renderFormAndTable = () => (
        <>
          {checklist.every(f => f.verified) && (
            <div className="bg-green-800/50 text-green-200 p-4 rounded-lg mb-8 text-center animate-pulse"><p className="font-bold">¡Excelente! El formulario ya está disponible.</p></div>
          )}
          <section className="mb-8 bg-gray-800 p-6 rounded-xl shadow-lg">
            <h2 className="text-xl font-bold text-white mb-4">Información de la Capacitación</h2>
            <div>
              <label htmlFor="sessionCourseName" className="block text-sm font-medium text-gray-300 mb-1">Nombre del curso</label>
              <input type="text" id="sessionCourseName" value={courseName} onChange={e => setCourseName(e.target.value)} placeholder="Escriba el nombre del curso aquí" className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500"/>
            </div>
          </section>
          
          <main className="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div className="lg:col-span-2"><AttendanceForm onSave={handleSaveRecord} disabled={!courseName.trim()} /></div>
            <div className="lg:col-span-3"><RecordsTable records={records} onExport={handleExportPDF} /></div>
          </main>
        </>
      );

      return (
        <div className="min-h-screen bg-gray-900 text-white font-sans p-4 sm:p-6 lg:p-8">
          <div className="container mx-auto">
            <header className="text-center mb-8">
              <h1 className="text-4xl font-extrabold tracking-tight">Registro de Asistencia</h1>
              <p className="text-gray-400 mt-2">Una solución moderna para registrar y gestionar la asistencia.</p>
            </header>

            {appState === 'setup' && renderSetup()}
            {appState === 'checklist' && renderChecklist()}
            {appState === 'form' && renderFormAndTable()}
            
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
