<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>registro de capacitaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        .signature-pad {
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: crosshair;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // =============== ICONS ===============
        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
            </svg>
        );

        const CheckIcon = ({ isVisible }) => (
            <svg xmlns="http://www.w3.org/2000/svg" 
                 className={`h-6 w-6 text-green-500 transition-all duration-300 ease-in-out ${isVisible ? 'scale-100 opacity-100' : 'scale-0 opacity-0'}`} 
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const LinkIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
               <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
            </svg>
        );

        const ClipboardIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
            </svg>
        );
        
        // =============== SIGNATURE PAD ===============
        const SignaturePad = ({ onSave }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
            }, []);

            const startDrawing = ({ nativeEvent }) => {
                const { offsetX, offsetY } = nativeEvent;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(offsetX, offsetY);
                setIsDrawing(true);
            };

            const draw = ({ nativeEvent }) => {
                if (!isDrawing) return;
                const { offsetX, offsetY } = nativeEvent;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.lineTo(offsetX, offsetY);
                ctx.stroke();
            };

            const stopDrawing = () => {
                setIsDrawing(false);
            };

            const clearPad = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            const handleSave = () => {
                const canvas = canvasRef.current;
                const dataUrl = canvas.toDataURL('image/png');
                onSave(dataUrl);
                clearPad();
            };

            return (
                <div className="w-full">
                    <canvas
                        ref={canvasRef}
                        width="300"
                        height="150"
                        className="w-full bg-white signature-pad"
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                    />
                    <div className="flex justify-between mt-2 space-x-2">
                        <button type="button" onClick={clearPad} className="w-1/2 px-4 py-2 bg-slate-300 text-slate-800 rounded-md shadow-sm hover:bg-slate-400 transition-colors">Limpiar</button>
                        <button type="button" onClick={handleSave} className="w-1/2 px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 transition-colors">Guardar Firma</button>
                    </div>
                </div>
            );
        };
        
        // =============== APP COMPONENT ===============
        const App = () => {
            const [appState, setAppState] = useState({
                stage: 'setup', // 'setup', 'share', 'checklist', 'form'
                trainingName: '',
                files: [{ url: '' }],
                visited: [],
                records: [],
            });

            const [shareableLink, setShareableLink] = useState('');
            
            const LOCAL_STORAGE_KEY = 'training-attendance-app';

            useEffect(() => {
                // Load from URL first
                const hash = window.location.hash.substring(1);
                if (hash) {
                    try {
                        const decodedState = JSON.parse(atob(hash));
                        setAppState(prevState => ({
                            ...prevState, // Keep existing records
                            ...decodedState,
                            stage: 'checklist',
                        }));
                        // Clear the hash so a refresh doesn't re-trigger this
                        window.location.hash = ''; 
                    } catch (e) {
                        console.error("Failed to parse state from URL, loading from localStorage.", e);
                        loadFromLocalStorage();
                    }
                } else {
                    // If no URL state, load from localStorage
                    loadFromLocalStorage();
                }
            }, []);
            
            const loadFromLocalStorage = () => {
                try {
                    const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (savedState) {
                        setAppState(JSON.parse(savedState));
                    }
                } catch (error) {
                    console.error("Could not load state from local storage", error);
                }
            }

            useEffect(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
                } catch (error) {
                    console.error("Could not save state to local storage", error);
                }
            }, [appState]);

            const handleFileChange = (index, value) => {
                const newFiles = [...appState.files];
                newFiles[index].url = value;
                setAppState(prev => ({...prev, files: newFiles}));
            };

            const addFile = () => {
                setAppState(prev => ({...prev, files: [...prev.files, { url: '' }]}));
            };

            const removeFile = (index) => {
                setAppState(prev => ({...prev, files: prev.files.filter((_, i) => i !== index)}));
            };

            const handleConfirmFiles = () => {
                const validFiles = appState.files.filter(f => f.url.trim() !== '');
                if (!appState.trainingName.trim() || validFiles.length === 0) {
                    alert("Por favor, ingrese el nombre de la capacitaciÃ³n y al menos un enlace.");
                    return;
                }
                
                const stateToShare = {
                    trainingName: appState.trainingName,
                    files: validFiles,
                    visited: new Array(validFiles.length).fill(false),
                };
                
                const encodedState = btoa(JSON.stringify(stateToShare));
                const newUrl = `${window.location.origin}${window.location.pathname}#${encodedState}`;
                setShareableLink(newUrl);

                setAppState(prev => ({...prev, stage: 'share'}));
            };

            const handleMarkVisited = (index) => {
                const newVisited = appState.visited.map((item, i) => i === index ? true : item);
                const newAppState = { ...appState, visited: newVisited };
                
                setAppState(newAppState);

                if (newVisited.every(v => v)) {
                    setTimeout(() => {
                        setAppState(prev => ({...prev, stage: 'form'}));
                    }, 500);
                }
            };
            
            const handleReset = () => {
                if (window.confirm("Â¿EstÃ¡s seguro de que quieres reiniciar? Se borrarÃ¡n todos los datos de la sesiÃ³n actual (enlaces y registros).")) {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    window.location.hash = '';
                    setAppState({
                        stage: 'setup',
                        trainingName: '',
                        files: [{ url: '' }],
                        visited: [],
                        records: [],
                    });
                }
            };

            // =============== RENDER METHODS ===============
            const renderHeader = () => (
                <header className="bg-white shadow-md p-4 mb-8 flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold text-indigo-600">Registro de Capacitaciones</h1>
                        {appState.trainingName && appState.stage !== 'setup' && (
                            <p className="text-slate-500 mt-1">Curso: <span className="font-semibold">{appState.trainingName}</span></p>
                        )}
                    </div>
                    <button 
                        onClick={handleReset} 
                        className="bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition-transform transform hover:scale-105"
                    >
                        Crear Nueva (Reiniciar)
                    </button>
                </header>
            );

            const renderSetup = () => (
                <div className="space-y-6 fade-in">
                    <h2 className="text-xl font-semibold text-center">Paso 1: Configurar CapacitaciÃ³n</h2>
                     <div>
                        <label htmlFor="trainingName" className="block text-sm font-medium text-slate-700 mb-1">Nombre de la CapacitaciÃ³n</label>
                        <input
                            type="text"
                            id="trainingName"
                            value={appState.trainingName}
                            onChange={(e) => setAppState(prev => ({...prev, trainingName: e.target.value}))}
                            className="w-full p-2 border border-slate-300 rounded-md shadow-sm"
                            placeholder="Ej: InducciÃ³n de Seguridad"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Enlaces de Archivos (Drive, YouTube, etc.)</label>
                        {appState.files.map((file, index) => (
                            <div key={index} className="flex items-center space-x-2 mb-2">
                                <LinkIcon />
                                <input
                                    type="text"
                                    value={file.url}
                                    onChange={(e) => handleFileChange(index, e.target.value)}
                                    className="flex-grow p-2 border border-slate-300 rounded-md shadow-sm"
                                    placeholder="https://..."
                                />
                                <button onClick={() => removeFile(index)} className="p-2 text-red-500 hover:text-red-700">
                                    <TrashIcon />
                                </button>
                            </div>
                        ))}
                        <button onClick={addFile} className="mt-2 px-4 py-2 text-sm bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">+ Agregar otro enlace</button>
                    </div>
                    <button onClick={handleConfirmFiles} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105">Confirmar y Generar Enlace</button>
                </div>
            );

            const renderShareLink = () => (
                <div className="text-center space-y-4 fade-in">
                    <h2 className="text-xl font-semibold">Paso 2: Comparte el Enlace</h2>
                    <p className="text-slate-600">EnvÃ­a este enlace a todos los asistentes. Al abrirlo, verÃ¡n la lista de archivos que deben revisar.</p>
                    <div className="p-4 bg-slate-200 border border-slate-300 rounded-lg break-words">
                        <code>{shareableLink}</code>
                    </div>
                    <button
                        onClick={() => {
                            navigator.clipboard.writeText(shareableLink);
                            alert('Enlace copiado al portapapeles!');
                        }}
                        className="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 flex items-center justify-center"
                    >
                       <ClipboardIcon /> Copiar Enlace
                    </button>
                    <button 
                        onClick={() => setAppState(prev => ({...prev, stage: 'checklist'}))}
                        className="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700"
                    >
                       Continuar a la Lista
                    </button>
                </div>
            );

            const renderChecklist = () => (
                <div className="space-y-4 fade-in">
                    <h2 className="text-xl font-semibold text-center">Paso 1: Revisar Material</h2>
                    <p className="text-center text-slate-600">Haz clic en cada enlace para abrir el material. Se marcarÃ¡ como visto automÃ¡ticamente.</p>
                    <ul className="space-y-3">
                        {appState.files.map((file, index) => (
                            <li key={index} className={`flex items-center justify-between p-4 rounded-lg shadow-sm transition-colors duration-300 ${appState.visited[index] ? 'bg-green-100' : 'bg-white'}`}>
                                <a
                                    href={file.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    onClick={() => handleMarkVisited(index)}
                                    className="flex-grow text-indigo-600 hover:underline"
                                >
                                    {`Material de CapacitaciÃ³n #${index + 1}`}
                                </a>
                                <CheckIcon isVisible={appState.visited[index]} />
                            </li>
                        ))}
                    </ul>
                </div>
            );
            
            // This is just a placeholder for the real form, which needs its own component.
            const renderFormAndTable = () => {
                // This will be replaced by the actual form component
                const [formKey, setFormKey] = useState(0);
                const [records, setRecords] = useState(appState.records);

                const addRecord = (newRecord) => {
                    const updatedRecords = [...records, { ...newRecord, id: Date.now() }];
                    setRecords(updatedRecords);
                    setAppState(prev => ({...prev, records: updatedRecords}));
                    setFormKey(prevKey => prevKey + 1); // Reset form
                };
                
                const handleExportPDF = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(18);
                    doc.text("Registro de Asistencia", 14, 22);
                    doc.setFontSize(12);
                    doc.text(`CapacitaciÃ³n: ${appState.trainingName}`, 14, 30);
                    doc.text(`Fecha de ExportaciÃ³n: ${new Date().toLocaleDateString()}`, 14, 38);

                    const tableColumn = ["Nombre", "Cargo", "Empresa", "Fecha", "Firma"];
                    const tableRows = [];

                    records.forEach(record => {
                        const recordData = [
                            record.participantName,
                            record.participantPosition,
                            record.participantEmpresa,
                            record.trainingDate,
                            '' // Placeholder for image
                        ];
                        tableRows.push(recordData);
                    });

                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 50,
                        didDrawCell: (data) => {
                            if (data.column.index === 4 && data.cell.section === 'body') {
                                const record = records[data.row.index];
                                if (record.signature) {
                                    doc.addImage(record.signature, 'PNG', data.cell.x + 2, data.cell.y + 2, 30, 15);
                                }
                            }
                        },
                         styles: {
                            cellPadding: { top: 2, right: 2, bottom: 2, left: 2 },
                            valign: 'middle'
                        },
                        columnStyles: {
                            4: { // Firma column
                                minCellWidth: 35,
                                minCellHeight: 20
                            }
                        }
                    });

                    doc.save("registro_asistencia.pdf");
                };


                return (
                    <div className="fade-in space-y-8">
                       <div>
                           <h2 className="text-xl font-semibold text-center mb-2">Paso 2: Registrar Asistencia</h2>
                           <AttendanceForm key={formKey} onSave={addRecord} />
                       </div>
                        {records.length > 0 && (
                            <div>
                                <h2 className="text-xl font-semibold text-center mb-4">Asistentes Registrados</h2>
                                <RecordsTable records={records} onExport={handleExportPDF} />
                            </div>
                        )}
                    </div>
                );
            };
            
            // Main component logic
            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                    {renderHeader()}
                    <main className="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg">
                        {appState.stage === 'setup' && renderSetup()}
                        {appState.stage === 'share' && renderShareLink()}
                        {appState.stage === 'checklist' && renderChecklist()}
                        {appState.stage === 'form' && renderFormAndTable()}
                    </main>
                </div>
            );
        };
        
        // =============== ATTENDANCE FORM ===============
        const AttendanceForm = ({ onSave }) => {
            const [formData, setFormData] = useState({
                trainingDate: new Date().toISOString().slice(0, 10),
                participantName: '',
                participantPosition: '',
                participantEmpresa: '',
                signature: null,
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSignatureSave = (signatureData) => {
                setFormData(prev => ({ ...prev, signature: signatureData }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.participantName || !formData.signature) {
                    alert('Por favor, complete su nombre y firma.');
                    return;
                }
                onSave(formData);
            };

            return (
                 <form onSubmit={handleSubmit} className="p-6 bg-slate-50 rounded-lg border border-slate-200">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-4">
                            <div>
                                <label htmlFor="participantName" className="block text-sm font-medium text-slate-700">Nombre Completo</label>
                                <input type="text" name="participantName" id="participantName" value={formData.participantName} onChange={handleChange} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                            </div>
                            <div>
                                <label htmlFor="participantPosition" className="block text-sm font-medium text-slate-700">Cargo</label>
                                <input type="text" name="participantPosition" id="participantPosition" value={formData.participantPosition} onChange={handleChange} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                            </div>
                             <div>
                                <label htmlFor="participantEmpresa" className="block text-sm font-medium text-slate-700">Empresa</label>
                                <input type="text" name="participantEmpresa" id="participantEmpresa" value={formData.participantEmpresa} onChange={handleChange} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                            </div>
                            <div>
                                <label htmlFor="trainingDate" className="block text-sm font-medium text-slate-700">Fecha</label>
                                <input type="date" name="trainingDate" id="trainingDate" value={formData.trainingDate} onChange={handleChange} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                            </div>
                        </div>
                         <div className="space-y-2">
                             <label className="block text-sm font-medium text-slate-700">Firma</label>
                            <SignaturePad onSave={handleSignatureSave} />
                            {formData.signature && (
                                <div className="text-center">
                                    <p className="text-sm text-green-600 font-semibold">Â¡Firma guardada!</p>
                                    <img src={formData.signature} alt="Firma guardada" className="mx-auto mt-2 border border-green-300 rounded-md h-16"/>
                                </div>
                            )}
                        </div>
                    </div>
                     <div className="mt-6 text-right">
                        <button type="submit" className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Agregar a la Lista
                        </button>
                    </div>
                </form>
            );
        };
        
        // =============== RECORDS TABLE ===============
        const RecordsTable = ({ records, onExport }) => {
            return (
                <div className="w-full bg-white p-6 rounded-lg border border-slate-200">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-200">
                            <thead className="bg-slate-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nombre</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Cargo</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Empresa</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Firma</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-slate-200">
                                {records.map((record) => (
                                    <tr key={record.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{record.participantName}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{record.participantPosition}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{record.participantEmpresa}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{record.trainingDate}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <img src={record.signature} alt="Firma" className="h-10"/>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-6 text-right">
                        <button onClick={onExport} className="px-6 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                           Exportar a PDF
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
