
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>registro de capacitaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-900 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { jsPDF } = window.jspdf;

        //============== ICONS ==============//
        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trash-2 text-red-500 hover:text-red-400"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );
        const CheckIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`lucide lucide-check ${className}`}><path d="M20 6 9 17l-5-5"/></svg>
        );

        //============== SIGNATURE PAD ==============//
        const SignaturePad = ({ onSave, signature }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                handleClear(); // Clear on initial render or when signature is cleared externally
            }, [signature]);

            const startDrawing = ({ nativeEvent }) => {
                const { offsetX, offsetY } = nativeEvent.touches ? nativeEvent.touches[0] : nativeEvent;
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(offsetX, offsetY);
                setIsDrawing(true);
            };

            const draw = ({ nativeEvent }) => {
                if (!isDrawing) return;
                const { offsetX, offsetY } = nativeEvent.touches ? nativeEvent.touches[0] : nativeEvent;
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(offsetX, offsetY);
                ctx.stroke();
            };

            const stopDrawing = () => {
                const ctx = canvasRef.current.getContext('2d');
                ctx.closePath();
                setIsDrawing(false);
            };

            const handleSave = () => {
                onSave(canvasRef.current.toDataURL('image/png'));
            };
            
            const handleClear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            return (
                <div className="flex flex-col gap-2">
                    <canvas
                        ref={canvasRef}
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                        onTouchStart={startDrawing}
                        onTouchMove={draw}
                        onTouchEnd={stopDrawing}
                        width="300"
                        height="150"
                        className="bg-slate-700 rounded-md cursor-crosshair touch-none"
                    ></canvas>
                    <div className="flex gap-2">
                        <button type="button" onClick={handleClear} className="w-full px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-md transition-colors">Limpiar</button>
                        <button type="button" onClick={handleSave} className="w-full px-4 py-2 bg-sky-600 hover:bg-sky-500 text-white font-bold rounded-md transition-colors">Guardar Firma</button>
                    </div>
                </div>
            );
        };

        //============== ATTENDANCE FORM ==============//
        const AttendanceForm = ({ onAddRecord, disabled }) => {
            const [formData, setFormData] = useState({
                participantName: '',
                participantPosition: '',
                participantEmpresa: '',
                trainingDate: new Date().toISOString().slice(0, 10),
                signature: '',
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSaveSignature = (signatureDataUrl) => {
                setFormData(prev => ({ ...prev, signature: signatureDataUrl }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.signature) {
                    alert('Por favor, guarde su firma antes de registrarse.');
                    return;
                }
                onAddRecord(formData);
                setFormData({
                    participantName: '',
                    participantPosition: '',
                    participantEmpresa: '',
                    trainingDate: new Date().toISOString().slice(0, 10),
                    signature: '',
                });
            };

            return (
                <div className="relative">
                    {disabled && (
                        <div className="absolute inset-0 bg-slate-800 bg-opacity-80 flex items-center justify-center z-10 rounded-lg">
                            <p className="text-lg font-semibold text-center">Complete los pasos anteriores<br/>para habilitar el registro.</p>
                        </div>
                    )}
                    <form onSubmit={handleSubmit} className={`p-6 bg-slate-800 rounded-lg shadow-lg grid grid-cols-1 md:grid-cols-2 gap-6 transition-opacity ${disabled ? 'opacity-30 pointer-events-none' : 'opacity-100'}`}>
                        <h2 className="text-2xl font-bold text-sky-400 col-span-full">Registrar Asistente</h2>
                        <div className="flex flex-col">
                            <label htmlFor="participantName" className="mb-1 font-semibold">Nombre Completo</label>
                            <input type="text" id="participantName" name="participantName" value={formData.participantName} onChange={handleChange} className="p-2 bg-slate-700 rounded-md border border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="participantPosition" className="mb-1 font-semibold">Cargo</label>
                            <input type="text" id="participantPosition" name="participantPosition" value={formData.participantPosition} onChange={handleChange} className="p-2 bg-slate-700 rounded-md border border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="participantEmpresa" className="mb-1 font-semibold">Empresa</label>
                            <input type="text" id="participantEmpresa" name="participantEmpresa" value={formData.participantEmpresa} onChange={handleChange} className="p-2 bg-slate-700 rounded-md border border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="trainingDate" className="mb-1 font-semibold">Fecha de Capacitación</label>
                            <input type="date" id="trainingDate" name="trainingDate" value={formData.trainingDate} onChange={handleChange} className="p-2 bg-slate-700 rounded-md border border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                        </div>
                        <div className="flex flex-col col-span-full md:col-span-1">
                            <label className="mb-1 font-semibold">Firma</label>
                            <SignaturePad onSave={handleSaveSignature} signature={formData.signature} />
                        </div>
                        <div className="col-span-full flex items-end">
                             <button type="submit" className="w-full px-4 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-md transition-colors text-lg">Añadir Registro</button>
                        </div>
                    </form>
                </div>
            );
        };
        
        //============== RECORDS TABLE ==============//
        const RecordsTable = ({ records, onExport }) => {
            return (
                <div className="p-6 bg-slate-800 rounded-lg shadow-lg mt-8">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-sky-400">Registros Guardados</h2>
                        <button onClick={onExport} disabled={records.length === 0} className="px-4 py-2 bg-sky-600 hover:bg-sky-500 text-white font-bold rounded-md transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed">Exportar a PDF</button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full">
                            <thead className="bg-slate-700">
                                <tr>
                                    <th className="px-4 py-2 text-left">Nombre</th>
                                    <th className="px-4 py-2 text-left">Cargo</th>
                                    <th className="px-4 py-2 text-left">Empresa</th>
                                    <th className="px-4 py-2 text-left">Fecha</th>
                                    <th className="px-4 py-2 text-left">Firma</th>
                                </tr>
                            </thead>
                            <tbody>
                                {records.map((record, index) => (
                                    <tr key={index} className="border-b border-slate-700">
                                        <td className="px-4 py-2">{record.participantName}</td>
                                        <td className="px-4 py-2">{record.participantPosition}</td>
                                        <td className="px-4 py-2">{record.participantEmpresa}</td>
                                        <td className="px-4 py-2">{record.trainingDate}</td>
                                        <td className="px-4 py-2">
                                            {record.signature && <img src={record.signature} alt="Firma" className="h-8 bg-white rounded p-1"/>}
                                        </td>
                                    </tr>
                                ))}
                                {records.length === 0 && (
                                    <tr>
                                        <td colSpan="5" className="text-center py-4 text-slate-400">Aún no hay registros.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        //============== MAIN APP ==============//
        const App = () => {
            const APP_STORAGE_KEY = 'trainingAttendanceApp';

            const getInitialState = () => {
                try {
                    const savedState = localStorage.getItem(APP_STORAGE_KEY);
                    if (savedState) {
                        return JSON.parse(savedState);
                    }
                } catch (error) {
                    console.error("Failed to parse state from localStorage", error);
                }
                return {
                    appState: 'setup', // 'setup', 'checklist', 'form'
                    files: [{ url: '', visited: false }],
                    records: [],
                    trainingName: ''
                };
            };
            
            const [appState, setAppState] = useState(getInitialState().appState);
            const [files, setFiles] = useState(getInitialState().files);
            const [records, setRecords] = useState(getInitialState().records);
            const [trainingName, setTrainingName] = useState(getInitialState().trainingName);

            useEffect(() => {
                const stateToSave = { appState, files, records, trainingName };
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(stateToSave));
            }, [appState, files, records, trainingName]);

            const handleFileChange = (index, value) => {
                const newFiles = [...files];
                newFiles[index].url = value;
                setFiles(newFiles);
            };

            const addFileField = () => {
                setFiles([...files, { url: '', visited: false }]);
            };

            const removeFileField = (index) => {
                const newFiles = files.filter((_, i) => i !== index);
                setFiles(newFiles);
            };
            
            const confirmFiles = () => {
                const validFiles = files.filter(file => file.url.trim() !== '');
                if (validFiles.length === 0) {
                    alert('Por favor, ingrese al menos un enlace.');
                    return;
                }
                 if (!trainingName.trim()) {
                    alert('Por favor, ingrese el nombre de la capacitación.');
                    return;
                }
                setFiles(validFiles.map(f => ({...f, visited: false }))); // Reset visited status on confirm
                setAppState('checklist');
            };

            const handleLinkClick = (index) => {
                const newFiles = [...files];
                newFiles[index].visited = true;
                setFiles(newFiles);
                
                if (newFiles.every(file => file.visited)) {
                    setTimeout(() => setAppState('form'), 1000);
                }
            };
            
            const handleAddRecord = (newRecord) => {
                setRecords(prev => [...prev, newRecord]);
            };

            const handleResetApp = () => {
                if(window.confirm("¿Está seguro de que desea reiniciar? Se borrarán todos los enlaces y registros guardados.")) {
                    localStorage.removeItem(APP_STORAGE_KEY);
                    setAppState('setup');
                    setFiles([{ url: '', visited: false }]);
                    setRecords([]);
                    setTrainingName('');
                }
            }

            const handleExport = () => {
                const doc = new jsPDF();
                doc.text(`Registro de Asistencia: ${trainingName}`, 14, 16);
                doc.text(`Fecha de Exportación: ${new Date().toLocaleDateString()}`, 14, 22);

                const tableColumn = ["Nombre", "Cargo", "Empresa", "Fecha", "Firma"];
                const tableRows = [];

                records.forEach(record => {
                    tableRows.push([
                        record.participantName,
                        record.participantPosition,
                        record.participantEmpresa,
                        record.trainingDate,
                        '' // Placeholder for image
                    ]);
                });

                doc.autoTable({
                    startY: 30,
                    head: [tableColumn],
                    body: tableRows,
                    didDrawCell: (data) => {
                        if (data.section === 'body' && data.column.index === 4) {
                            const record = records[data.row.index];
                            if (record.signature) {
                                doc.addImage(record.signature, 'PNG', data.cell.x + 2, data.cell.y + 2, 30, 15);
                            }
                        }
                    },
                    columnStyles: { 4: { cellWidth: 35 } },
                    rowPageBreak: 'auto',
                });
                
                doc.save(`asistencia_${trainingName.replace(/\s+/g, '_') || 'capacitacion'}.pdf`);
            };
            
            const renderSetup = () => (
                <div className="p-6 bg-slate-800 rounded-lg shadow-lg flex flex-col gap-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-sky-400">Paso 1: Configurar Archivos</h2>
                        <button onClick={handleResetApp} className="px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-md transition-colors text-sm">Reiniciar</button>
                    </div>
                    <p>Pegue los enlaces a los archivos que los asistentes deben revisar.</p>
                    {files.map((file, index) => (
                        <div key={index} className="flex items-center gap-2">
                            <input
                                type="url"
                                placeholder="https://docs.google.com/..."
                                value={file.url}
                                onChange={(e) => handleFileChange(index, e.target.value)}
                                className="w-full p-2 bg-slate-700 rounded-md border border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"
                            />
                            {files.length > 1 && (
                                <button onClick={() => removeFileField(index)} type="button">
                                    <TrashIcon />
                                </button>
                            )}
                        </div>
                    ))}
                    <div className="flex flex-col sm:flex-row gap-4">
                        <button onClick={addFileField} type="button" className="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-md transition-colors">
                            + Agregar otro enlace
                        </button>
                        <button onClick={confirmFiles} type="button" className="flex-grow px-4 py-2 bg-sky-600 hover:bg-sky-500 text-white font-bold rounded-md transition-colors">
                            Confirmar Archivos
                        </button>
                    </div>
                     <div className="flex flex-col mt-4">
                        <label htmlFor="trainingName" className="mb-1 font-semibold">Nombre de la Capacitación</label>
                        <input 
                            type="text" 
                            id="trainingName" 
                            name="trainingName" 
                            value={trainingName} 
                            onChange={(e) => setTrainingName(e.target.value)} 
                            className="p-2 bg-slate-700 rounded-md border border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500" 
                            placeholder="Ej: Inducción de Seguridad"
                            required 
                        />
                    </div>
                </div>
            );

            const renderChecklist = () => (
                <div className="p-6 bg-slate-800 rounded-lg shadow-lg flex flex-col gap-4">
                    <h2 className="text-2xl font-bold text-sky-400">Paso 2: Revisar Archivos</h2>
                    <p>Haga clic en cada enlace para abrirlo. El formulario se habilitará cuando todos los archivos hayan sido visitados.</p>
                    <ul className="flex flex-col gap-3">
                        {files.map((file, index) => (
                            <li key={index} className="flex items-center gap-3 p-3 bg-slate-700 rounded-md">
                                <CheckIcon className={file.visited ? 'text-green-500' : 'text-slate-500'} />
                                <a
                                    href={file.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    onClick={() => handleLinkClick(index)}
                                    className="text-sky-400 hover:text-sky-300 hover:underline flex-grow truncate"
                                >
                                    {file.url}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            );
            
            return (
                <main className="container mx-auto p-4 md:p-8 max-w-4xl">
                    <header className="text-center mb-8">
                        <h1 className="text-4xl font-extrabold text-sky-400">Registro de Asistencia a Capacitaciones</h1>
                        {trainingName && appState !== 'setup' && (
                             <p className="text-xl mt-2 text-slate-300">{trainingName}</p>
                        )}
                    </header>
                    
                    {appState === 'setup' && renderSetup()}
                    {appState === 'checklist' && renderChecklist()}
                    {appState === 'form' && (
                        <div>
                            <div className="p-4 mb-6 bg-green-900 border border-green-700 text-green-200 rounded-lg text-center">
                                <p className="font-bold">¡Excelente! Ha completado la revisión de archivos.</p>
                                <p>Ahora puede proceder con el registro de asistencia.</p>
                            </div>
                            <AttendanceForm onAddRecord={handleAddRecord} disabled={false} />
                            <RecordsTable records={records} onExport={handleExport} />
                        </div>
                    )}
                </main>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
